<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>PyMongo & Mongodb Replica Set - Cheng's Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="/mongo replica set and pymongo.html">

        <meta name="author" content="Cheng" />
        <meta name="keywords" content="MongoDB,Python" />
        <meta name="description" content="记录工作项目中MongoDB的从standalone迁移到replica set环境，而后pymongo所需要考虑的配置调整" />

    <!-- Enable latex plugin -->




    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>




</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
Cheng's Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="/category/cloud.html">Cloud</a>
                        </li>
                        <li class="active">
                            <a href="/category/database.html">Database</a>
                        </li>
                        <li >
                            <a href="/category/domain.html">Domain</a>
                        </li>
                        <li >
                            <a href="/category/java.html">Java</a>
                        </li>
                        <li >
                            <a href="/category/other.html">Other</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/mongo replica set and pymongo.html"
                       rel="bookmark"
                       title="Permalink to PyMongo & Mongodb Replica Set">
                        PyMongo & Mongodb Replica Set
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2014-10-01T22:00:00+08:00"> Wed 01 October 2014</time>
    </span>






<span class="label label-default">Tags</span>
	<a href="/tag/mongodb.html">MongoDB</a>
        /
	<a href="/tag/python.html">Python</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>I have built up the MongoDB replica set could be used for some test.</p>
<table>
<thead>
<tr>
<th>Role</th>
<th>PROPERTY</th>
</tr>
</thead>
<tbody>
<tr>
<td>PRIMARY</td>
<td>HOST_A:PORT</td>
</tr>
<tr>
<td>SECONDARY</td>
<td>HOST_B:PORT</td>
</tr>
<tr>
<td>SECONDARY</td>
<td>HOST_C:PORT</td>
</tr>
</tbody>
</table>
<h2>About Failover</h2>
<p>From the perspective of Mongo side, the replica set will attempt to select another member to become the new primary.<br />
From the perspective of a client application, whether a MongoDB instance is running as a single server (i.e. “standalone”) or a replica set is transparent.<br />
However when a failover occurs, PyMongo will automatically attempt to find the new primary node and perform subsequent operations on that node, this can’t happen completely transparently.<br />
After change origin client settings to :  </p>
<div class="highlight"><pre>mongo = MongoClient([&#39;C0043950.itcs.hp.com:27017&#39;,&#39;C0045057.itcs.hp.com:27017&#39;,&#39;c0045576.itcs.hp.com:27017&#39;],replicaSet=&#39;rs-1&#39;)
</pre></div>


<p>When failover happens (for example: PRIMARY node change from C0043950 to C0045057 after the election), transition will happen after an Error throwed.<br />
1.  Connection will throw   <code>AutoReconnect Error</code><br />
    Browser page will get 500 response.<br />
2.  Refresh the page next time , PyMongo will automatically attempt to switch to the primary node. So the reply will be right.  </p>
<p>References:<br />
1. <a href="http://stackoverflow.com/questions/26063346/in-pymongo-given-a-mongos-what-is-the-difference-between-normal-and-rs-clients/26387515#26387515">What is the difference between normal and RS clients</a>  <br />
2. <a href="http://api.mongodb.org/python/current/examples/high_availability.html#handling-failover">Handing-failover</a> <br />
3. <a href="http://api.mongodb.org/python/current/examples/high_availability.html#mongoreplicasetclient">might consider using MongoReplicaSetClient if necessary.</a>  </p>
<h2>About Consistency</h2>
<p>Consistency of MongoDB is sometime called eventual consistency because the secondary member’s state will eventually reflect the primary’s state and but MongoDB cannot guarantee strict consistency for read operations from secondary members.<br />
By default, in MongoDB, read operations to a replica set return results from the primary and are consistent with the last write operation.<br />
Users may configure read preference on a per-connection basis to prefer that the read operations return on the secondary members. If clients configure the read preference to permit secondary reads, read operations can return from secondary members that have not replicated more recent updates or operations. When reading from a secondary, a query may return data that reflects a previous state.<br />
Secondaries nodes apply operations from the primary node asynchronously. By applying operations after the primary, sets can continue to function without some members.   </p>
<p>In some cases, we can use replication to increase read capacity. <br />
Leverage through this “eventual consistency”, for some less important data (for example , Logs) we could adjust the Write Concern ensure faster performance rather than ensure persistence to the entire deployment. <br />
1. First set the read preference could from Secondaries<br />
<code>mongo = MongoClient("host:port",read_preference=ReadPreference.SECONDARY)</code> <br />
2. Then we will have the default write concern for the PyMongo instance.<br />
<code>mongo.write_concern = {'w': 3, 'wtimeout': 1000}</code><br />
3. For other specific operations that don’t need such consistency , we could add the w value explicitly.<br />
<code>db.remove({'_id':ObjectId(id)}, w=1)</code>  </p>
<p>References:<br />
1. <a href="http://docs.mongodb.org/manual/applications/replication/">Replica Set Read and Write Semantics</a><br />
2. <a href="http://docs.mongodb.org/manual/reference/glossary/#term-read-preference">Read Preference</a><br />
3. <a href="http://docs.mongodb.org/manual/core/write-concern/">Write Concern</a><br />
4. <a href="http://docs.mongodb.org/manual/release-notes/drivers-write-concern/">Driver Write Concern</a>  <br />
5. <a href="http://api.mongodb.org/python/current/api/pymongo/mongo_client.html#pymongo.mongo_client.MongoClient.write_concern">PyMongo write_concern</a>    </p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
                  <ul class="list-group" id="social">
                    <li class="list-group-item"><a href="#"><i class="fa fa-you-can-add-links-in-your-config-file-square fa-lg"></i> You can add links in your config file</a></li>
                    <li class="list-group-item"><a href="#"><i class="fa fa-another-social-link-square fa-lg"></i> Another social link</a></li>
                  </ul>
                </li>



                <li class="list-group-item"><a href="/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                    <ul class="list-group " id="tags">
                        <li class="list-group-item tag-1">
                            <a href="/tag/java.html">
                                Java
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="/tag/python.html">
                                Python
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="/tag/database.html">
                                Database
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="/tag/mongodb.html">
                                MongoDB
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="/tag/nosql.html">
                                NoSQL
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="/tag/.html">
                                
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="/tag/oracle.html">
                                Oracle
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="/tag/cloud.html">
                                Cloud
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="/tag/pelican.html">
                                pelican
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="/tag/markdownbiao-ji-yu-yan.html">
                                Markdown，标记语言
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="/tag/isolation.html">
                                Isolation
                            </a>
                        </li>
                    </ul>
                </li>    



    <li class="list-group-item"><h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
    </li>
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://getpelican.com/" target="_blank">
                Pelican
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://python.org/" target="_blank">
                Python.org
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://jinja.pocoo.org/" target="_blank">
                Jinja2
            </a>
        </li>
        <li class="list-group-item">
            <a href="#" target="_blank">
                You can modify those links in your config file
            </a>
        </li>
      </ul>
    </li>

        </ul>
    </section>

</aside>        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2014 Cheng
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>

    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = '/theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'berialcheng',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="/theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-49522852-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->
</body>
</html>